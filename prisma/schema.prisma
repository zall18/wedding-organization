// =======================
// GENERATOR & DATASOURCE
// =======================
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================
// ENUMS
// =======================
enum UserRole {
  SUPER_ADMIN // bisa manage multiple events
  ADMIN // full access per event
  STAFF // check-in & foto langsung WA
}

enum GuestStatus {
  INVITED
  CONFIRMED
  ATTENDED
  CANCELLED
  NO_SHOW
}

enum CheckInMethod {
  QR_SCAN // scan QR code
  MANUAL_SEARCH // cari nama/telepon
  MANUAL_ENTRY // input manual staff
}

enum InvitationType {
  PUBLIC // link bisa diakses siapa saja
  PRIVATE // hanya yang punya QR/undangan
}

enum VenueType {
  INDOOR
  OUTDOOR
  BALLROOM
  GARDEN
  BEACH
  MASJID
  CHURCH
  TEMPLE
  VENUE
}

enum PhotoDeliveryStatus {
  PENDING // baru diupload
  PROCESSING // sedang dikompres
  SENDING // sedang kirim WA
  DELIVERED // terkirim ke WA
  FAILED // gagal kirim
}

// =======================
// EVENT (WEDDING) - SIMPLIFIED
// =======================
model Event {
  // üîë Identifiers
  id        Int    @id @default(autoincrement())
  slug      String @unique
  shortCode String @unique @db.VarChar(6) // untuk display: "AB123C"

  // üë∞ü§µ Couple Info
  groomName    String
  brideName    String
  weddingTitle String // "The Wedding of Andi & Sari"

  // üóìÔ∏è Date & Time
  date      DateTime
  startTime DateTime
  endTime   DateTime

  // üìç Location
  venueName     String
  venueType     VenueType
  address       String
  googleMapsUrl String?

  // üé® Simple Theme
  primaryColor  String  @default("#7C3AED")
  logoUrl       String?
  coverImageUrl String?

  // üîê Access Control
  invitationType InvitationType @default(PRIVATE)
  isActive       Boolean        @default(true)
  isPublished    Boolean        @default(false)

  // ‚öôÔ∏è Simple Settings
  allowPhotoOnCheckIn Boolean @default(true) // foto langsung pas check-in
  autoSendPhotoToWA   Boolean @default(true) // langsung kirim ke WA
  enableRSVP          Boolean @default(true) // enable RSVP
  showLiveCount       Boolean @default(true) // tampilkan count tamu datang

  // üìä Stats (real-time)
  totalGuests    Int @default(0)
  confirmedCount Int @default(0)
  attendedCount  Int @default(0)

  // üìù Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relations
  users        User[]
  guests       Guest[]
  checkIns     CheckInLog[]
  photos       EventPhoto[]
  whatsAppLogs WhatsAppLog[]
  guestWishes  GuestWish[]
  eventStats   EventStats[]

  // üîç Indexes
  @@index([slug])
  @@index([shortCode])
  @@index([isActive, isPublished])
}

// =======================
// USER - SIMPLIFIED
// =======================
model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  phone    String? @db.VarChar(20)
  password String // hashed

  name      String
  avatarUrl String?
  role      UserRole @default(STAFF)

  // Event assignment (staff hanya 1 event)
  eventId Int?
  event   Event? @relation(fields: [eventId], references: [id])

  // Activity tracking
  lastLoginAt DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isActive  Boolean  @default(true)

  // Relations
  checkIns    CheckInLog[] // check-in yang dilakukan staff
  eventPhotos EventPhoto[]

  // Indexes
  @@index([email])
  @@index([eventId])
  @@index([role])
}

// =======================
// GUEST - SIMPLIFIED
// =======================
model Guest {
  id Int @id @default(autoincrement())

  name  String
  phone String  @db.VarChar(20)
  email String?

  category  String  @default("REGULAR")
  groupName String?

  invitedCount   Int @default(1)
  plusOneAllowed Int @default(0)

  status  GuestStatus @default(INVITED)
  qrCode  String      @unique @default(uuid())
  shortId String      @unique @db.VarChar(8)

  checkedInAt DateTime?
  checkedInBy String?

  waMessageId String?

  rsvpStatus String?   @default("PENDING")
  rsvpNote   String?
  rsvpDate   DateTime?

  eventId Int
  event   Event @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  checkIns     CheckInLog[]
  photos       EventPhoto[] // üì∏ semua foto guest
  whatsAppLogs WhatsAppLog[]
  guestWishes  GuestWish[]

  @@unique([eventId, phone])
  @@index([eventId])
  @@index([phone])
  @@index([qrCode])
  @@index([shortId])
  @@index([status])
  @@index([category])
}

// =======================
// CHECK-IN LOG - WITH PHOTO
// =======================
model CheckInLog {
  id Int @id @default(autoincrement())

  guestId Int
  guest   Guest @relation(fields: [guestId], references: [id])

  eventId Int
  event   Event @relation(fields: [eventId], references: [id])

  arrivedCount Int           @default(1)
  method       CheckInMethod

  checkedInById Int?
  checkedInBy   User? @relation(fields: [checkedInById], references: [id])

  // üì∏ FOTO CHECK-IN HANYA DI SINI
  photoId Int?        @unique
  photo   EventPhoto? @relation(fields: [photoId], references: [id])

  deviceType    String?
  deviceBrowser String?

  checkedInAt DateTime @default(now())

  @@index([eventId, checkedInAt])
  @@index([guestId])
  @@index([checkedInById])
  @@index([method])
}

// =======================
// EVENT PHOTO - SIMPLIFIED
// =======================
model EventPhoto {
  id Int @id @default(autoincrement())

  filename      String
  filePath      String
  thumbnailPath String?

  fileSize Int
  mimeType String
  width    Int?
  height   Int?

  eventId Int
  event   Event @relation(fields: [eventId], references: [id])

  guestId Int?
  guest   Guest? @relation(fields: [guestId], references: [id])

  takenAt   DateTime @default(now())
  takenById Int?
  takenBy   User?    @relation(fields: [takenById], references: [id])

  waStatus    PhotoDeliveryStatus @default(PENDING)
  waMessageId String?
  waError     String?
  waSentAt    DateTime?

  retryCount  Int       @default(0)
  nextRetryAt DateTime?

  // üìå RELASI KE CHECK-IN
  checkInLog CheckInLog?

  whatsAppLogs WhatsAppLog[]

  @@index([eventId, takenAt])
  @@index([guestId])
  @@index([waStatus])
  @@index([takenById])
}

// =======================
// WHATSAPP MESSAGE LOG
// =======================
model WhatsAppLog {
  id Int @id @default(autoincrement())

  // Message Info
  messageId  String  @unique // dari WA API
  templateId String? // template WA yang digunakan

  // Recipient
  toPhone String  @db.VarChar(20)
  toName  String?

  // Content
  messageType String  @default("PHOTO") // "PHOTO", "TEXT", "INVITATION"
  caption     String?

  // Photo Reference
  photoId Int?
  photo   EventPhoto? @relation(fields: [photoId], references: [id])

  // Guest Reference
  guestId Int?
  guest   Guest? @relation(fields: [guestId], references: [id])

  // Status
  status String  @default("SENT") // "SENT", "DELIVERED", "READ", "FAILED"
  error  String?

  // Metadata
  eventId Int
  event   Event @relation(fields: [eventId], references: [id])

  sentAt      DateTime  @default(now())
  deliveredAt DateTime?
  readAt      DateTime?

  // Indexes
  @@index([eventId, sentAt])
  @@index([toPhone])
  @@index([guestId])
  @@index([photoId])
  @@index([status])
}

// =======================
// GUEST WISHES (OPTIONAL SIMPLE)
// =======================
model GuestWish {
  id Int @id @default(autoincrement())

  // Content
  message   String
  fromName  String
  fromPhone String? @db.VarChar(20)

  // Privacy
  isPublic Boolean @default(true)

  // Metadata
  eventId Int
  event   Event @relation(fields: [eventId], references: [id])

  guestId Int?
  guest   Guest? @relation(fields: [guestId], references: [id])

  createdAt DateTime @default(now())

  // Indexes
  @@index([eventId, createdAt])
  @@index([guestId])
}

// =======================
// REAL-TIME DASHBOARD STATS
// =======================
model EventStats {
  id Int @id @default(autoincrement())

  // Live Counts
  eventId Int
  event   Event @relation(fields: [eventId], references: [id])

  totalGuests   Int @default(0)
  guestsArrived Int @default(0)
  guestsPending Int @default(0)

  // Check-in Stats
  checkInsLastHour Int     @default(0)
  peakHour         String? // "19:00"

  // Photo Stats
  photosTaken  Int @default(0)
  photosSent   Int @default(0)
  photosFailed Int @default(0)

  // Hourly snapshot
  snapshotTime DateTime @default(now())

  // Indexes
  @@unique([eventId, snapshotTime])
  @@index([eventId])
  @@index([snapshotTime])
}
